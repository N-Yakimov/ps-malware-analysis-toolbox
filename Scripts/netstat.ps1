# Define the output folder and CSV file path
$exportFolderPath = "Scripts/Exports"
$csvPath = Join-Path -Path $exportFolderPath -ChildPath "netstat.csv"

# Check if the export folder exists, and create it if it doesn't
if (!(Test-Path -Path $exportFolderPath -PathType Container)) {
    New-Item -Path $exportFolderPath -ItemType Directory | Out-Null
}

Write-Host "Running netstat for 60 seconds and capturing results"

# Start a background job to run netstat -a command
$job = Start-Job -ScriptBlock { netstat -a }

# Display countdown for 1 minute
for ($i = 60; $i -ge 1; $i--) {
    Write-Host -NoNewline "Waiting for $i seconds...`r"
    Start-Sleep -Seconds 1
}

# Retrieve the job output and stop the job
$netstatOutput = Receive-Job -Job $job
Stop-Job -Job $job

# Process the netstat output and extract the desired fields
$processedOutput = $netstatOutput | ForEach-Object {
    $line = $_ -replace '\s+', ','
    $fields = $line -split ','
    [PSCustomObject]@{
        Proto = $fields[0]
        'Local Address' = $fields[1]
        'Foreign Address' = $fields[2]
        State = $fields[3]
        PSComputerName = $env:COMPUTERNAME
    }
}

# Select only the desired columns
$processedOutput = $processedOutput | Select-Object Proto, 'Local Address', 'Foreign Address', State, PSComputerName

# Append the processed output to the CSV file
$processedOutput | Export-Csv -Path $csvPath -NoTypeInformation -Append

Write-Host "Netstat information saved to: $csvPath"